# 操作队列

Cocoa操作（operation）是一种面向对象的方式来封装您想要异步执行的工作。操作被设计用来和操作队列（operation queue）一起使用或者由他们自己使用。因为他们是基于Objective-C，操作常用于基于Cocoa的OS X和iOS应用程序。

下面介绍如何定义和使用操作。



### 关于操作对象

操作对象是`NSOperation`类（在Foundation框架中）的实例，使用它来封装您想要您应用程序执行的工作。`NSOperation`类本身是一个抽象基类，必须将其子类化才能做任何有用的工作。尽管是抽象的，这个类确实提供了大量的基础结构，以减少您在自己子类中的工作量。此外，基础框架提供了两个具体子类，您可以和您已经存在的代码一样使用。下标列出了这些类，和一些怎么使用他们的摘要信息。

| 类                     | 描述                                       |
| --------------------- | ---------------------------------------- |
| NSInvocationOperation | 您可以使用此类从您应用程序中基于一个对象（object）和选择器（selector）创建一个操作对象。如果已经存在一个执行任务所需要的方法，您可以使用此类。因为它不需要子类化，您也可以以更动态的方式使用此类创建操作对象。有关如何使用这个类的信息，请参阅[创建NSInvocationOperation对象](#创建NSInvocationOperation对象)。 |
| NSBlockOperation      | 您可以使用此类并发的执行一个或者多个块对象（block object）。因为太可以执行多个块，所以块操作对象使用组语义操作。只有当所有相关联的块都执行完成时，操作本身才被认为完成操作。有关如何使用这个类的信息，请参阅[创建NSBlockOperation对象](#创建NSBlockOperation对象)。 |
| NSOperation           | 用于定义自定义操作对象的基类，子类化`NSOperation`给你完全的控制权来实现您自己的操作，包括改变操作执行的默认行为和记录其状态。有关如何定义自定义操作对象的信息，请参阅[定义自定义操作对象](#定义自定义操作对象)。 |



所有操作对象都支持以下主要特性：

- 支持在操作对象间建立基于图的依赖关系。这些依赖关系阻止给定的操作运行，直到它所依赖的所有操作都运行结束。有关如何配置依赖，请参阅[配置并发执行操作](#配置并发执行操作)。
- 支持一个可选的完成块（completion block），在操作的主任务完成后执行。有关如何设置完成块，请参阅[设置完成块](#设置完成块)。
- 支持使用KVO通知监视操作执行状态变化。有关如何观察KVO通知，请参阅[维持KVO规范](#维持KVO规范)。
- 支持优先级操作，从而影响相对执行顺序。欲了解跟多信息，请参阅[更改操作的执行优先级](#更改操作的执行优先级)。
- 支持取消语义，允许您在执行操作时停止操作。有关如何取消操作，请参阅[取消操作](#取消操作)。有关如何在您自己的操作中支持取消，请参阅[响应取消事件](#响应取消事件)。

操作的设计是为了帮助您在您的应用程序中改善并发的级别。





### 并发操作与非并发操作

### 创建NSInvocationOperation对象

### 创建NSBlockOperation对象

### 定义自定义操作对象

#### 执行主要任务

#### 响应取消事件

#### 配置并发执行操作

#### 维持KVO规范

### 自定义操作对象的执行行为

#### 配置相互依赖关系

#### 更改操作的执行优先级

#### 更改基础线程优先级

#### 设置完成块

### 实现操作对象的小贴士

#### 管理操作对象内存

##### 避免Per-Thread存储

##### 根据需要保留对操作对象的引用

#### 处理错误和异常

### 确定操作对象的相应范围

### 执行操作

#### 添加操作到操作队列

#### 手动执行操作

#### 取消操作

#### 等待操作完成

#### 暂停与恢复队列